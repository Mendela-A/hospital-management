{% extends "base.html" %}

{% block title %}–°–ø–∏—Å–æ–∫ –ø–∞—Ü—ñ—î–Ω—Ç—ñ–≤{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">–ü–∞—Ü—ñ—î–Ω—Ç–∏ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å</h1>
        <div class="flex gap-2">
            {% if current_user.is_admin() %}
            <a href="{{ url_for('export.export_form') }}" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                üìä –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel
            </a>
            {% endif %}
            <a href="{{ url_for('patients.add') }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                + –î–æ–¥–∞—Ç–∏ –ø–∞—Ü—ñ—î–Ω—Ç–∞
            </a>
        </div>
    </div>

    <!-- –§—ñ–ª—å—Ç—Ä–∏ —Ç–∞ –ø–æ—à—É–∫ -->
    <form method="GET" class="mb-6 bg-gray-50 p-4 rounded">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" name="search" placeholder="–ü–æ—à—É–∫ –∑–∞ –ü–Ü–ë –∞–±–æ ‚Ññ —ñ—Å—Ç–æ—Ä—ñ—ó" 
                   value="{{ request.args.get('search', '') }}"
                   class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <select name="department" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">–í—Å—ñ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</option>
                {% for dept in departments %}
                <option value="{{ dept }}" {% if request.args.get('department') == dept %}selected{% endif %}>{{ dept }}</option>
                {% endfor %}
            </select>
            
            <select name="doctor" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">–í—Å—ñ –ª—ñ–∫–∞—Ä—ñ</option>
                {% for doc in doctors %}
                <option value="{{ doc }}" {% if request.args.get('doctor') == doc %}selected{% endif %}>{{ doc }}</option>
                {% endfor %}
            </select>
            
            <select name="status" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                <option value="alive" {% if request.args.get('status') == 'alive' %}selected{% endif %}>–ñ–∏–≤—ñ</option>
                <option value="deceased" {% if request.args.get('status') == 'deceased' %}selected{% endif %}>–ü–æ–º–µ—Ä–ª—ñ</option>
            </select>
        </div>
        <div class="mt-4 flex gap-2">
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
            <a href="{{ url_for('patients.index') }}" class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">–°–∫–∏–Ω—É—Ç–∏</a>
        </div>
    </form>

    <!-- –¢–∞–±–ª–∏—Ü—è -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–Ω—è</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–î–∞—Ç–∞ –≤–∏–ø–∏—Å–∫–∏</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–ü–Ü–ë</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–õ—ñ–∫–∞—Ä</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‚Ññ –Ü—Å—Ç–æ—Ä—ñ—ó</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–°—Ç–∞—Ç—É—Å</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–î—ñ—ó</th>
                </tr>
            </thead>
            <tbody>
                {% for patient in patients %}
                <tr class="border-b hover:bg-gray-50 {% if patient.is_deceased %}bg-red-50{% endif %}">
                    <td class="px-4 py-3 text-sm">{{ patient.admission_date.strftime('%d.%m.%Y') }}</td>
                    <td class="px-4 py-3 text-sm">
                        {% if patient.discharge_date %}
                            {{ patient.discharge_date.strftime('%d.%m.%Y') }}
                        {% else %}
                            <span class="text-gray-400">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm font-medium">{{ patient.full_name }}</td>
                    <td class="px-4 py-3 text-sm">{{ patient.department }}</td>
                    <td class="px-4 py-3 text-sm">{{ patient.doctor }}</td>
                    <td class="px-4 py-3 text-sm">{{ patient.history_number }}</td>
                    <td class="px-4 py-3 text-sm">
                        {% if patient.is_deceased %}
                            <span class="bg-red-500 text-white px-2 py-1 rounded text-xs">–ü–æ–º–µ—Ä</span>
                        {% else %}
                            <span class="bg-green-500 text-white px-2 py-1 rounded text-xs">–ñ–∏–≤–∏–π</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex gap-2">
                            <a href="{{ url_for('patients.edit', id=patient.id) }}" 
                               class="text-blue-600 hover:text-blue-800">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                            {% if current_user.is_admin() %}
                            <form method="POST" action="{{ url_for('patients.delete', id=patient.id) }}" 
                                  onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –ø–∞—Ü—ñ—î–Ω—Ç–∞?');">
                                <button type="submit" class="text-red-600 hover:text-red-800">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                        –ü–∞—Ü—ñ—î–Ω—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
    {% if pagination.pages > 1 %}
    <div class="mt-6 flex justify-center gap-2">
        {% if pagination.has_prev %}
            <a href="{{ url_for('patients.index', page=pagination.prev_num, search=request.args.get('search', ''), department=request.args.get('department', ''), doctor=request.args.get('doctor', ''), status=request.args.get('status', '')) }}" 
               class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">–ü–æ–ø–µ—Ä–µ–¥–Ω—è</a>
        {% endif %}
        
        <span class="px-4 py-2 bg-gray-100 rounded">–°—Ç–æ—Ä—ñ–Ω–∫–∞ {{ pagination.page }} –∑ {{ pagination.pages }}</span>
        
        {% if pagination.has_next %}
            <a href="{{ url_for('patients.index', page=pagination.next_num, search=request.args.get('search', ''), department=request.args.get('department', ''), doctor=request.args.get('doctor', ''), status=request.args.get('status', '')) }}" 
               class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">–ù–∞—Å—Ç—É–ø–Ω–∞</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}